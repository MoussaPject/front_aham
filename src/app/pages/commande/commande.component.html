<div class="min-h-screen bg-gray-50 py-12">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 space-y-8">

    <!-- ================= HEADER ================= -->
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-6">
      <div>
        <h1 class="text-3xl font-extrabold text-gray-900 tracking-tight">
          Commande #{{ commande?.reference || ('CMD-' + commande?.id) }}
        </h1>
        <p class="mt-2 text-sm text-gray-600 max-w-xl">
          {{ commande?.user?.name || 'Client' }}
          <span *ngIf="commande?.user?.email" class="text-gray-400">
            · {{ commande?.user?.email }}
          </span>
        </p>
        <p *ngIf="commande?.date_commande" class="mt-1 text-xs text-gray-500">
          Passée le {{ commande?.date_commande | date:'dd/MM/yyyy HH:mm' }}
        </p>
      </div>

      <button
        type="button"
        (click)="retournerAuCatalogue()"
        class="inline-flex items-center gap-2 px-5 py-2.5 rounded-lg bg-white border border-gray-300
               text-gray-700 hover:bg-gray-50 shadow-sm"
      >
        <i class="fas fa-arrow-left"></i>
        Retour à mes commandes
      </button>
    </div>

    <!-- ================= PROGRESSION ================= -->
    <div *ngIf="commande && !isLoading" class="bg-white rounded-2xl shadow-md border border-gray-100 p-5 space-y-4">
      <div class="flex items-center justify-between">
        <h2 class="text-sm font-semibold text-gray-900">Progression de la commande</h2>
        <span class="text-xs text-gray-600">
          Statut :
          <span class="ml-1 inline-flex items-center px-2 py-0.5 rounded-full bg-indigo-50 text-indigo-700 font-medium">
            {{ getStatutLabel() }}
          </span>
        </span>
      </div>

      <div class="flex items-center justify-between text-xs text-gray-500">
        <div class="flex-1 flex items-center">
          <!-- Étape 1 -->
          <div class="flex flex-col items-center flex-1" [ngClass]="{'text-indigo-600': getStepIndex() >= 1}">
            <div
              class="w-8 h-8 rounded-full border-2 flex items-center justify-center text-xs font-semibold"
              [ngClass]="getStepIndex() >= 1 ? 'border-indigo-600 bg-indigo-600 text-white' : 'border-gray-300 bg-white text-gray-500'"
            >
              1
            </div>
            <span class="mt-1 text-[11px]">En Attente</span>
          </div>

          <div class="h-0.5 flex-1 mx-1" [ngClass]="getStepIndex() > 1 ? 'bg-indigo-500' : 'bg-gray-200'"></div>

          <!-- Étape 2 -->
          <div class="flex flex-col items-center flex-1" [ngClass]="{'text-indigo-600': getStepIndex() >= 2}">
            <div
              class="w-8 h-8 rounded-full border-2 flex items-center justify-center text-xs font-semibold"
              [ngClass]="getStepIndex() >= 2 ? 'border-indigo-600 bg-indigo-600 text-white' : 'border-gray-300 bg-white text-gray-500'"
            >
              2
            </div>
            <span class="mt-1 text-[11px]">Confirmée</span>
          </div>

          <div class="h-0.5 flex-1 mx-1" [ngClass]="getStepIndex() > 2 ? 'bg-indigo-500' : 'bg-gray-200'"></div>

          <!-- Étape 3 -->
          <div class="flex flex-col items-center flex-1" [ngClass]="{'text-indigo-600': getStepIndex() >= 3}">
            <div
              class="w-8 h-8 rounded-full border-2 flex items-center justify-center text-xs font-semibold"
              [ngClass]="getStepIndex() >= 3 ? 'border-indigo-600 bg-indigo-600 text-white' : 'border-gray-300 bg-white text-gray-500'"
            >
              3
            </div>
            <span class="mt-1 text-[11px]">Expédiée</span>
          </div>

          <div class="h-0.5 flex-1 mx-1" [ngClass]="getStepIndex() > 3 ? 'bg-indigo-500' : 'bg-gray-200'"></div>

          <!-- Étape 4 -->
          <div class="flex flex-col items-center flex-1" [ngClass]="{'text-indigo-600': getStepIndex() >= 4}">
            <div
              class="w-8 h-8 rounded-full border-2 flex items-center justify-center text-xs font-semibold"
              [ngClass]="getStepIndex() >= 4 ? 'border-indigo-600 bg-indigo-600 text-white' : 'border-gray-300 bg-white text-gray-500'"
            >
              4
            </div>
            <span class="mt-1 text-[11px]">Livrée</span>
          </div>
        </div>
      </div>

      <p class="text-xs text-gray-600">
        {{ getEtapeDescription() }}
      </p>
    </div>

    <!-- ================= LOADING / ERROR ================= -->
    <div *ngIf="isLoading" class="py-20 text-center text-gray-500">
      Chargement de votre commande...
    </div>

    <div *ngIf="errorMessage && !isLoading"
         class="rounded-lg bg-red-50 border border-red-200 p-4 text-sm text-red-700">
      {{ errorMessage }}
    </div>

    <!-- ================= MAIN CONTENT ================= -->
    <div *ngIf="commande && !isLoading" class="grid grid-cols-1 lg:grid-cols-2 gap-8">

      <!-- ================================================= -->
      <!-- ============ RÉCAP COMMANDE ==================== -->
      <!-- ================================================= -->
      <section class="bg-white rounded-2xl shadow-md border border-gray-100 p-6 space-y-6">

        <!-- Header -->
        <div class="flex items-start justify-between">
          <div>
            <h2 class="text-lg font-semibold text-gray-900">Récapitulatif de la commande</h2>
            <p class="mt-1 text-xs text-gray-500">
              Produits sélectionnés et montant total
            </p>
          </div>
          <div class="text-right text-xs text-gray-500">
            <div>Référence</div>
            <div class="font-mono text-sm text-gray-800">
              {{ commande.reference || ('CMD-' + commande.id) }}
            </div>
          </div>
        </div>

        <!-- Status -->
        <div class="flex items-center justify-between text-xs text-gray-500 border-t pt-4">
          <span>
            Statut :
            <span class="ml-1 inline-flex items-center px-2 py-0.5 rounded-full
                         bg-emerald-100 text-emerald-700 font-medium">
              {{ commande.statut }}
            </span>
          </span>
          <span>{{ commande.date_commande | date:'short' }}</span>
        </div>

        <!-- Items -->
        <div class="divide-y border-y max-h-96 overflow-y-auto pr-1">
          <div *ngFor="let item of commande.items" class="py-5 flex gap-5">

            <!-- Image -->
            <div class="w-20 h-20 rounded-lg overflow-hidden bg-gray-100 border">
              <img
                [src]="item.produit.image ? 'http://127.0.0.1:8000/storage/' + item.produit.image : 'assets/images/no-image.jpg'"
                (error)="onImageError($event)"
                class="w-full h-full object-cover"
              />
            </div>

            <!-- Infos -->
            <div class="flex-1 min-w-0 space-y-1">
              <h3 class="text-sm font-semibold text-gray-900 truncate">
                {{ item.produit.nom }}
              </h3>

              <p class="text-xs text-gray-500 line-clamp-2">
                {{ item.produit.description }}
              </p>

              <!-- Tags -->
              <div class="flex flex-wrap gap-2 text-[11px] mt-2">
                <span class="px-2 py-0.5 bg-gray-100 rounded-full uppercase">
                  {{ item.produit.type }}
                </span>
                <span *ngIf="item.produit.matiere" class="px-2 py-0.5 bg-gray-100 rounded-full">
                  {{ item.produit.matiere }}
                </span>
                <span *ngIf="item.produit.couleur" class="px-2 py-0.5 bg-gray-100 rounded-full">
                  {{ item.produit.couleur }}
                </span>
              </div>
            </div>

            <!-- Prix -->
            <div class="text-right">
              <div class="text-sm font-semibold text-gray-900">
                {{ (item.prix_unitaire * item.quantite) | number:'1.0-0' }} XOF
              </div>
              <div class="text-xs text-gray-500">
                {{ item.quantite }} {{ item.produit.unite }} × {{ item.prix_unitaire | number:'1.0-0' }} XOF
              </div>
            </div>
          </div>
        </div>

        <!-- Avis produits (uniquement si commande livrée/terminée) -->
        <div *ngIf="estCommandeLivree()" class="mt-6 border-t pt-4 space-y-4">
          <h3 class="text-sm font-semibold text-gray-900">
            Donnez votre avis sur vos produits
          </h3>
          <p class="text-xs text-gray-500">
            Votre avis nous aide à améliorer la qualité de nos tissus et de notre service.
          </p>

          <div *ngFor="let item of commande.items" class="pt-3 border-t first:border-t-0 first:pt-0 space-y-2">
            <div class="flex items-center justify-between gap-3">
              <div class="text-xs text-gray-700 font-medium truncate">
                {{ item.produit.nom }}
              </div>

              <div class="flex items-center gap-2 text-xs">
                <label class="text-gray-600">Note :</label>
                <select
                  class="border border-gray-300 rounded-md px-2 py-1 text-xs bg-white"
                  [(ngModel)]="avisNotes[item.produit.id]"
                >
                  <option [ngValue]="null">Choisir</option>
                  <option [ngValue]="1">1</option>
                  <option [ngValue]="2">2</option>
                  <option [ngValue]="3">3</option>
                  <option [ngValue]="4">4</option>
                  <option [ngValue]="5">5</option>
                </select>
              </div>
            </div>

            <textarea
              rows="2"
              class="w-full rounded-lg border border-gray-300 bg-gray-50 text-xs p-2 focus:ring-2 focus:ring-indigo-500"
              placeholder="Partagez votre ressenti sur ce produit (optionnel)"
              [(ngModel)]="avisCommentaires[item.produit.id]"
            ></textarea>

            <div class="flex items-center justify-between gap-3 text-[11px]">
              <div class="text-gray-500" *ngIf="!avisSuccess[item.produit.id]">
                Vous ne pouvez laisser qu'un avis par produit.
              </div>
              <div class="text-emerald-600" *ngIf="avisSuccess[item.produit.id]">
                {{ avisSuccess[item.produit.id] }}
              </div>
              <div class="text-red-600" *ngIf="avisError[item.produit.id]">
                {{ avisError[item.produit.id] }}
              </div>

              <button
                type="button"
                class="ml-auto inline-flex items-center gap-1 px-3 py-1.5 rounded-lg bg-indigo-600 text-white text-xs hover:bg-indigo-700 disabled:opacity-50"
                [disabled]="avisLoading[item.produit.id]"
                (click)="soumettreAvis(item)"
              >
                <span *ngIf="!avisLoading[item.produit.id]">Envoyer mon avis</span>
                <span *ngIf="avisLoading[item.produit.id]">Envoi...</span>
              </button>
            </div>
          </div>
        </div>

        <!-- Total -->
        <div class="flex justify-between items-center bg-gray-50 rounded-xl p-4">
          <div class="text-xs text-gray-500">
            Paiement à la livraison
          </div>
          <div class="text-right">
            <div class="text-xs text-gray-500">Total à payer</div>
            <div class="text-2xl font-extrabold text-gray-900">
              {{ commande.total | number:'1.0-0' }} XOF
            </div>
          </div>
        </div>
      </section>

      <!-- ================================================= -->
      <!-- ============ RÉCAP + FORMULAIRE LIVRAISON ======= -->
      <!-- ================================================= -->
      <section class="bg-white rounded-2xl shadow-md border border-gray-100 p-6 flex flex-col space-y-4">

        <!-- Titre -->
        <div class="flex items-start justify-between gap-3 mb-1">
          <div>
            <h2 class="text-lg font-semibold text-gray-900">Informations de livraison</h2>
            <p class="mt-1 text-xs text-gray-500">
              Adresse de livraison et coordonnées utilisées par le livreur.
            </p>
          </div>

          <div *ngIf="commande.mode_livraison" class="inline-flex items-center px-3 py-1 rounded-full bg-indigo-50 text-[11px] text-indigo-700 font-semibold">
            <i class="fas fa-shipping-fast mr-1"></i>
            {{ commande.mode_livraison }}
          </div>
        </div>

        <!-- Récapitulatif livraison existante -->
        <div *ngIf="commande.livraison; else aucuneLivraison"
             class="rounded-xl border border-indigo-100 bg-indigo-50 p-4 text-xs text-gray-700 space-y-3">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-2">
              <span class="inline-flex items-center justify-center w-7 h-7 rounded-full bg-indigo-600 text-white text-xs">
                <i class="fas fa-map-marker-alt"></i>
              </span>
              <div>
                <div class="text-[11px] uppercase tracking-wide text-indigo-700 font-semibold">Adresse enregistrée</div>
                <div class="text-[11px] text-indigo-900">Dernière mise à jour par vos soins</div>
              </div>
            </div>

            <div *ngIf="commande.livraison.statut" class="px-2 py-0.5 rounded-full text-[10px] font-semibold"
                 [ngClass]="commande.livraison.statut.toLowerCase() === 'livree' || commande.livraison.statut.toLowerCase() === 'livrée'
                            ? 'bg-emerald-100 text-emerald-700'
                            : 'bg-indigo-100 text-indigo-700'">
              {{ commande.livraison.statut }}
            </div>
          </div>

          <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
            <div class="space-y-1">
              <div class="font-semibold text-gray-900 text-xs flex items-center gap-2">
                <i class="fas fa-user text-gray-500"></i>
                {{ commande.livraison.nom_client || commande.user?.name || 'Client' }}
              </div>
              <div class="flex items-center gap-2 text-gray-600">
                <i class="fas fa-phone-alt text-gray-400"></i>
                <span>{{ commande.livraison.telephone || 'Non renseigné' }}</span>
              </div>
              <div class="flex items-center gap-2 text-gray-600">
                <i class="fas fa-city text-gray-400"></i>
                <span>{{ commande.livraison.ville || 'Ville non renseignée' }}</span>
              </div>
            </div>

            <div class="space-y-1">
              <div class="flex items-start gap-2 text-gray-600">
                <i class="fas fa-home text-gray-400 mt-0.5"></i>
                <span class="leading-snug">
                  {{ commande.livraison.adresse || 'Adresse de livraison non renseignée pour le moment.' }}
                </span>
              </div>

              <div class="flex items-center gap-2 text-gray-600" *ngIf="commande.livraison.transporteur || commande.livraison.frais">
                <i class="fas fa-truck text-gray-400"></i>
                <span>
                  <ng-container *ngIf="commande.livraison.transporteur">{{ commande.livraison.transporteur }}</ng-container>
                  <ng-container *ngIf="commande.livraison.frais"> · {{ commande.livraison.frais | number:'1.0-0' }} XOF</ng-container>
                </span>
              </div>

              <div class="flex items-center gap-2 text-gray-600" *ngIf="commande.livraison.date_livraison">
                <i class="fas fa-calendar-check text-gray-400"></i>
                <span>Prévue le {{ commande.livraison.date_livraison | date:'dd/MM/yyyy' }}</span>
              </div>
            </div>
          </div>

          <div *ngIf="commande.livraison.instructions" class="pt-2 mt-1 border-t border-indigo-100 text-gray-700 flex gap-2">
            <i class="fas fa-info-circle text-indigo-500 mt-0.5"></i>
            <p class="text-[11px] leading-snug">{{ commande.livraison.instructions }}</p>
          </div>

          <div *ngIf="commande.note_client" class="pt-2 mt-1 border-t border-indigo-100 text-gray-700 flex gap-2">
            <i class="fas fa-sticky-note text-indigo-500 mt-0.5"></i>
            <p class="text-[11px] leading-snug">Note client : {{ commande.note_client }}</p>
          </div>
        </div>

        <!-- Message si aucune livraison encore enregistrée -->
        <ng-template #aucuneLivraison>
          <div class="rounded-xl border border-dashed border-gray-300 bg-gray-50 p-4 text-xs text-gray-500 flex items-start gap-3">
            <i class="fas fa-info-circle mt-0.5 text-gray-400"></i>
            <div>
              Aucune information de livraison n'a encore été enregistrée pour cette commande.
              Remplissez le formulaire ci-dessous pour préciser votre adresse complète et les instructions pour le livreur.
            </div>
          </div>
        </ng-template>

        <!-- FORMULAIRE DE MISE À JOUR DES INFORMATIONS -->
        <form [formGroup]="livraisonForm" (ngSubmit)="onSubmit()"
              class="flex-1 flex flex-col space-y-4 pt-2">

          <!-- Coordonnées -->
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div>
              <label class="text-xs font-medium text-gray-700">Nom complet</label>
              <input
                formControlName="nom_client"
                class="mt-1 w-full rounded-lg border-gray-300 bg-gray-50
                       focus:ring-2 focus:ring-indigo-500 text-sm"
              />
            </div>

            <div>
              <label class="text-xs font-medium text-gray-700">Téléphone</label>
              <input
                formControlName="telephone"
                class="mt-1 w-full rounded-lg border-gray-300 bg-gray-50
                       focus:ring-2 focus:ring-indigo-500 text-sm"
              />
            </div>

            <div>
              <label class="text-xs font-medium text-gray-700">Ville</label>
              <input
                formControlName="ville"
                class="mt-1 w-full rounded-lg border-gray-300 bg-gray-50
                       focus:ring-2 focus:ring-indigo-500 text-sm"
              />
            </div>

            <div>
              <label class="text-xs font-medium text-gray-700">Adresse complète</label>
              <textarea
                rows="3"
                formControlName="adresse"
                class="mt-1 w-full rounded-lg border-gray-300 bg-gray-50
                       focus:ring-2 focus:ring-indigo-500 text-sm"
              ></textarea>
            </div>
          </div>

          <div>
            <label class="text-xs font-medium text-gray-700">
              Instructions (optionnel)
            </label>
            <textarea
              rows="2"
              formControlName="instructions"
              class="mt-1 w-full rounded-lg border-gray-300 bg-gray-50
                     focus:ring-2 focus:ring-indigo-500 text-sm"
            ></textarea>
          </div>

          <!-- CTA -->
          <div class="mt-auto pt-4 border-t flex items-center justify-between gap-4">
            <p class="text-[11px] text-gray-500 max-w-xs">
              Paiement à la livraison. Une facture vous sera envoyée par email.
            </p>

            <button
              type="submit"
              [disabled]="isSaving"
              class="inline-flex items-center gap-2 px-6 py-3 rounded-xl text-white
                     bg-gradient-to-r from-indigo-600 to-blue-600
                     hover:from-indigo-700 hover:to-blue-700
                     shadow-lg text-sm font-semibold disabled:opacity-60"
            >
              <i class="fas fa-truck"></i>
              Confirmer la livraison
            </button>
          </div>

        </form>
      </section>
    </div>
  </div>
</div>
